dist: xenial
language: cpp
branches:
  only:
    - master
before_install:
  # add modern repo for loading boost 1.67 packages, want thread_pool
  - sudo cp config_travis/cosmic_packages.pref /etc/apt/preferences.d/cosmic_package-repo.pref
  - sudo cp config_travis/cosmic.list          /etc/apt/sources.list.d/cosmic.list

  # add qt repo
  - sudo apt-add-repository ppa:beineri/opt-qt-5.12.0-xenial -y
  - sudo apt-get update -qq

install:
  # install boost 1.67 from cosmic repo and qt
  - sudo apt-get --y install qt512base qt512declarative qt512quickcontrols2
  - sudo apt-get install libboost-all-dev libprotobuf-dev protobuf-compiler -t cosmic

  - mkdir build
  - QTDIR="/opt/qt512"
  - PATH="$QTDIR/bin:$PATH"
  - source /opt/qt512/bin/qt512-env.sh
  - mkdir build

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
      - libpq-dev # and may be postgresql
      - libpqxx-dev
      - postgresql-server-dev-all
script:
  - CXX=/usr/bin/g++-7 CC=/usr/bin/gcc-7
  - cd protocol

  # that is how to generate files for serialization/deserialization
  - protoc  --cpp_out=../server/src/proto messages.proto
  - protoc  --cpp_out=../client/src/protobuf messages.proto

  - cd ../build
  - cmake -DCMAKE_PREFIX_PATH=/opt/qt512/lib/cmake ..
  # build both client and server
  - cmake --build .
