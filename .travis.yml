language: cpp
sudo: required
dist: xenial
compiler:
  - gcc
os:
  - linux
branches:
  only:
    - master
before_install:
  # firstly install qt, cause cosmic_packages broke qt packages dependencies (why?)
  # add qt repo
  - sudo add-apt-repository --yes ppa:beineri/opt-qt-5.12.0-xenial
  - sudo apt-get update -qq
  - sudo apt-get -y install qt512-meta-minimal

  - QTDIR="/opt/qt512"
  - PATH="$QTDIR/bin:$PATH"
  - source /opt/qt512/bin/qt512-env.sh
  - mkdir build
install:
  # add modern repo for loading boost 1.67 packages, want thread_pool
  - sudo cp config_travis/cosmic_packages.pref /etc/apt/preferences.d/cosmic_package-repo.pref
  - sudo cp config_travis/cosmic.list          /etc/apt/sources.list.d/cosmic.list
  - sudo apt-get update -qq

  # install boost 1.67 from cosmic repo
  - sudo apt-get -y install libboost-all-dev libprotobuf-dev protobuf-compiler -t cosmic
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
      - libpq-dev # and may be postgresql
      - libpqxx-dev
      - postgresql-server-dev-all
script:
  - CXX=/usr/bin/g++-7 CC=/usr/bin/gcc-7
  - cd protocol

  # that is how to generate files for serialization/deserialization
  - protoc  --cpp_out=../server/src/proto messages.proto
  - protoc  --cpp_out=../client/src/protobuf messages.proto

  - cd ../build
  - cmake -DCMAKE_PREFIX_PATH=/opt/qt512/lib/cmake ..
  # build both client and server
  - cmake --build .
